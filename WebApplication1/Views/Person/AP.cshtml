@model BLL.PageModel.AuthModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}
<script src="~/lib/crypto-js/crypto-js.js"></script>
<script src="~/lib/crypto-js/aes.js"></script>
<script src="~/lib/crypto-js/hmac-sha512.js"></script>
<script src="~/lib/crypto-js/sha512.js"></script>
<script src="~/js/Encryption.js"></script>
<style type="text/css">
    .row {
        width: 400px !important;
        margin-top: 10%;
        margin-left: 30%;
    }

    .span {
        color: blue;
    }
</style>
<div class="container">
    <div class="row">
        <div class="col-12">
            @{
                if (!Model.IsSuccess)
                {
                    <script type="text/javascript">
                            $('#msgModalbody').text('@Model.ErrorMsg').css({ 'color': 'blue'});;
                            $('#msgModal').modal('show');
                    </script>
                }

                using (Html.BeginForm("Save", "Person", FormMethod.Post, new { id = "APForm" }))
                {
                    @Html.AntiForgeryToken()
                    <div class="form-group" style="display:none;">
                        @Html.TextBoxFor(m => m.AuthenticId)
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.Account)
                        @Html.TextBoxFor(m => m.Account, new { @class = "form-control" })
                        <span asp-validation-for='Account' class="message"></span>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.Password)
                        @Html.TextBoxFor(m => m.Password, new { @class = "form-control", @type = "password" })
                        <span class="span">需變動密碼時，請重新輸入</span>
                        <span asp-validation-for='Password' class="message"></span>
                    </div>
                    <input type="button" class="btn btn-primary btn-block" id="submit" value="Save" />
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                }
            }
        </div>
    </div>
</div>
@Html.Partial("BootstrapModal")

<script type="text/javascript">
    $(function () {
        $("#Account").val(Decrypt('@Html.Raw(Model.Account)')); //帳號解碼

        $("#submit").click(function () {
            if ($("#APForm").valid()) {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("UpdateAuth", "Person")',
                    data: {
                        __RequestVerificationToken: '@GetAntiXsrfRequestToken()',
                        authenticId: $("#AuthenticId").val(),
                        account: Encrypt($("#Account").val()),
                        password: CryptoJS.SHA512($("#Password").val()).toString(),
                    },
                    async: true,
                    success: function (data) {
                        if (data != null) {
                            $('#msgModalbody').text(data).css({ 'color': 'blue' });;
                            $('#msgModal').modal('show');
                        }
                    },
                    error: function (error) {
                        if (error != null && error.responseText != '') {
                            $('#msgModalbody').text(error.responseText).css({ 'color': 'red' });
                            $('#msgModal').modal('show');
                        }
                    }
                });
                $("#Password").val('');
            }
        });
    });
</script>
